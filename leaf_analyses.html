<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Jocelyn Navarro, John M. Powers, Ayaka Paul, Diane R. Campbell" />

<meta name="date" content="2022-02-16" />

<title>Code for “Phenotypic plasticity and selection on leaf traits in response to snowmelt timing and summer precipitation”</title>

<script src="libs/header-attrs-2.11/header-attrs.js"></script>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>
<script src="libs/navigation-1.1/codefolding.js"></script>
<link href="libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Code for “Phenotypic plasticity and selection on leaf traits in response to snowmelt timing and summer precipitation”</h1>
<h4 class="author">Jocelyn Navarro, John M. Powers, Ayaka Paul, Diane R. Campbell</h4>
<h4 class="date">2022-02-16</h4>

</div>


<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>
<pre class="r"><code>library(tidyverse)
library(lubridate)

library(lme4)
library(lmerTest)
library(MuMIn)
library(glmmTMB)
library(emmeans)
library(broom)
library(broom.mixed)
library(vegan)

library(RColorBrewer)
library(viridis)
library(gridExtra)
library(patchwork)
library(GGally)
library(ggnewscale)

library(knitr)
knitr::opts_chunk$set(comment=&quot;&quot;, cache=T, warning = F, message = F, 
                      fig.path = &quot;figures-pdf/&quot;, 
                      dev=&quot;svglite&quot;, dev=&quot;cairo_pdf&quot;)#dev.args=list(fix_text_size=FALSE))#dev=&quot;cairo_pdf&quot;)
options(digits=4) # for kables

load(&quot;data/maxfield_data.rda&quot;)

options(contrasts = c(&quot;contr.sum&quot;, &quot;contr.poly&quot;)) #needed for Type III SS

anova_table &lt;- function(df, mod) { #for lmer models and lmerTest::anova
  df %&gt;% select(trait, term, p.value) %&gt;% 
    pivot_wider(names_from=term, values_from=p.value) %&gt;% 
    mutate(R2m = map_dbl(mod, ~ MuMIn::r.squaredGLMM(.x)[[1,&quot;R2m&quot;]]))
}
Anova_table &lt;- function(df) { #for glmmTMB models and car::Anova
  df %&gt;% select(Trait=trait, term, p.value) %&gt;% 
    pivot_wider(names_from=term, values_from=p.value,names_repair=&quot;unique&quot;)
}
select &lt;- dplyr::select
lptraits &lt;- c(leaftraits, phystraits)</code></pre>
<div id="metadata" class="section level1">
<h1>Metadata</h1>
<pre class="r"><code>alldata &lt;- list(&quot;treatments&quot;=treatments %&gt;% select(year, plotid, water, water4, snow, sun_date,precip_est_mm),
                &quot;leaftraits&quot;=lt.plantyr %&gt;% 
                  select(year, round, day, plotid, plant, VWC.sm, any_of(c(leaftraits, fitnesstraits))) %&gt;% 
                  arrange(year, round, plotid) %&gt;% drop_na(plant) %&gt;% filter(plant!=&quot;NA&quot;),
                &quot;phystraits&quot;=pt.plantyr %&gt;% 
                  select(year, round, plotid, plant, VWC.plant, VWC.sm, any_of(c(phystraits, fitnesstraits))) %&gt;% 
                  arrange(year, round, plotid) %&gt;% drop_na(plant) %&gt;% filter(plant!=&quot;NA&quot;))

purrr::walk(names(alldata), ~write_tsv(alldata[[.]], paste0(&quot;data/&quot;,., &quot;.tsv&quot;), na=&quot;&quot;))</code></pre>
<p>The following datasets are available in tab-delimited (TSV) format under the ‘data’ folder.</p>
<div id="treatments" class="section level2">
<h2>Treatments</h2>
<table>
<caption>The precipitation and snowmelt treatments in the split-plot design, with snowmelt dates for each plot and precipitation totals for each subplot.</caption>
<colgroup>
<col width="22%" />
<col width="77%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Column</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">year</td>
<td align="left">year</td>
</tr>
<tr class="even">
<td align="left">plotid</td>
<td align="left">plot number and subplot letter</td>
</tr>
<tr class="odd">
<td align="left">water</td>
<td align="left">precipitation treatment, with mock rainouts combined with controls</td>
</tr>
<tr class="even">
<td align="left">water4</td>
<td align="left">precipitation treatment, with mock rainouts separate from controls</td>
</tr>
<tr class="odd">
<td align="left">snow</td>
<td align="left">snowmelt treatment (in 2019, plot 2 was covered but coded as normal)</td>
</tr>
<tr class="even">
<td align="left">sun_date</td>
<td align="left">snowmelt date in each plot, determined by sunlight threshold</td>
</tr>
<tr class="odd">
<td align="left">precip_est_mm</td>
<td align="left">estimated summer precipitation in each subplot (see Methods S1)</td>
</tr>
</tbody>
</table>
</div>
<div id="morphological-traits" class="section level2">
<h2>Morphological traits</h2>
<table>
<colgroup>
<col width="22%" />
<col width="77%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Column</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">year</td>
<td align="left">year</td>
</tr>
<tr class="even">
<td align="left">round</td>
<td align="left">the first or second round of measurements (early/late summer)</td>
</tr>
<tr class="odd">
<td align="left">day</td>
<td align="left">the day of the year measurement was taken</td>
</tr>
<tr class="even">
<td align="left">plotid</td>
<td align="left">plot number and subplot letter</td>
</tr>
<tr class="odd">
<td align="left">plant</td>
<td align="left">unique plant identifier</td>
</tr>
<tr class="even">
<td align="left">VWC.sm</td>
<td align="left">the soil moisture averaged across the subplot on the date nearest the measurement</td>
</tr>
<tr class="odd">
<td align="left">sla</td>
<td align="left">specific leaf area (cm² g⁻¹)</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="left">trichome density (cm⁻²)</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="left">leaf water content (g H₂O g⁻¹)</td>
</tr>
<tr class="even">
<td align="left">survived</td>
<td align="left">whether the plant survived to the next year</td>
</tr>
<tr class="odd">
<td align="left">RGR</td>
<td align="left">relative growth rate from this year to the next (year⁻¹)</td>
</tr>
<tr class="even">
<td align="left">flowered</td>
<td align="left">whether the plant flowered the next year</td>
</tr>
</tbody>
</table>
</div>
<div id="physiological-traits" class="section level2">
<h2>Physiological traits</h2>
<table>
<colgroup>
<col width="22%" />
<col width="77%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Column</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">year</td>
<td align="left">year</td>
</tr>
<tr class="even">
<td align="left">round</td>
<td align="left">the date the measurement was taken</td>
</tr>
<tr class="odd">
<td align="left">plotid</td>
<td align="left">plot number and subplot letter</td>
</tr>
<tr class="even">
<td align="left">plant</td>
<td align="left">unique plant identifier</td>
</tr>
<tr class="odd">
<td align="left">VWC.plant</td>
<td align="left">the soil moisture next to the plant on the date of measurement</td>
</tr>
<tr class="even">
<td align="left">VWC.sm</td>
<td align="left">the soil moisture averaged across the subplot on the date nearest the measurement</td>
</tr>
<tr class="odd">
<td align="left">photosynthesis</td>
<td align="left">photosynthetic rate (µmol CO₂ m⁻² s⁻¹)</td>
</tr>
<tr class="even">
<td align="left">conductance</td>
<td align="left">stomatal conductance (mol H₂O m⁻² s⁻¹)</td>
</tr>
<tr class="odd">
<td align="left">WUE</td>
<td align="left">intrinsic water-use efficiency (µmol CO₂ mol⁻¹ H₂O)</td>
</tr>
<tr class="even">
<td align="left">survived</td>
<td align="left">whether the plant survived to the next year</td>
</tr>
<tr class="odd">
<td align="left">RGR</td>
<td align="left">relative growth rate from this year to the next (year⁻¹)</td>
</tr>
<tr class="even">
<td align="left">flowered</td>
<td align="left">whether the plant flowered the next year</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="sample-sizes" class="section level1">
<h1>Sample sizes</h1>
<pre class="r"><code>count_measurements &lt;- function(df, tr) summarize(df, across(all_of(tr), ~ sum(!is.na(.x)))) %&gt;% deframe()

data.frame(dataset = c(&quot;Morphological traits&quot;, &quot;Physiological traits&quot;),
           leaves = c(count_measurements(lt, &quot;leaf_area_cm2&quot;), count_measurements(pt, &quot;photosynthesis&quot;)),
           plants = c(lt %&gt;% group_by(plantid) %&gt;% summarize(across(all_of(&quot;leaf_area_cm2&quot;), mean, na.rm=T)) %&gt;%
                        count_measurements(&quot;leaf_area_cm2&quot;), 
                      pt %&gt;% group_by(plantid) %&gt;% summarize(across(all_of(&quot;photosynthesis&quot;), mean, na.rm=T)) %&gt;%
                        count_measurements(&quot;photosynthesis&quot;))) %&gt;% kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">dataset</th>
<th align="right">leaves</th>
<th align="right">plants</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Morphological traits</td>
<td align="right">600</td>
<td align="right">264</td>
</tr>
<tr class="even">
<td align="left">Physiological traits</td>
<td align="right">327</td>
<td align="right">275</td>
</tr>
</tbody>
</table>
</div>
<div id="trait-correlations" class="section level1">
<h1>Trait correlations</h1>
<pre class="r"><code>full_join(pt %&gt;% select(year, date, plantid, conductance, WUE, photosynthesis),
          lt %&gt;% select(year, year.round, plantid, sla, water_content, trichome_density)) %&gt;% 
  ggcorr(hjust=0.85, layout.exp=2, label=T, label_round=2)</code></pre>
<embed src="figures-pdf/correlations-1.pdf" width="672" type="application/pdf" />
</div>
<div id="replicated-split-plot-models" class="section level1">
<h1>Replicated split-plot models</h1>
<div id="table-1" class="section level2">
<h2>Table 1</h2>
<pre class="r"><code>lt.subplot.r2 &lt;- lt.subplotround %&gt;% filter(round==&quot;2&quot;) 
lt.plantyr.r2 &lt;- lt.plantyr %&gt;% filter(round==&quot;2&quot;)

options(contrasts = c(&quot;contr.sum&quot;, &quot;contr.poly&quot;))
mod.split &lt;- c(map(set_names(leaftraits), 
                   ~ lmer(lt.plantyr.r2[[.x]] ~ year * snow * water + (1|snow:plot) + (1|snow:plotid),
                          data=lt.plantyr.r2)),
               map(set_names(phystraits), 
                   ~ lmer(pt.plantyr[[.x]]    ~ year * snow * water + (1|snow:plot) + (1|snow:plotid) + (1|round),
                          data=pt.plantyr)))

mod.split.coefs &lt;- map_dfr(mod.split, tidy, .id=&quot;trait&quot;)
mod.split.tests &lt;- map(mod.split, anova, ddf=&quot;Ken&quot;) %&gt;% map_dfr(tidy, .id=&quot;trait&quot;)
mod.split.emm &lt;- map_dfr(mod.split, ~ summary(emmeans(ref_grid(.x), ~ year * snow * water)), .id = &quot;trait&quot;)
  anova_table(mod.split.tests, mod.split) %&gt;% kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">trait</th>
<th align="right">year</th>
<th align="right">snow</th>
<th align="right">water</th>
<th align="right">year:snow</th>
<th align="right">year:water</th>
<th align="right">snow:water</th>
<th align="right">year:snow:water</th>
<th align="right">R2m</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.0000</td>
<td align="right">0.1519</td>
<td align="right">0.6661</td>
<td align="right">0.0120</td>
<td align="right">0.7884</td>
<td align="right">0.2773</td>
<td align="right">0.1535</td>
<td align="right">0.6027</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.0000</td>
<td align="right">0.4894</td>
<td align="right">0.5712</td>
<td align="right">0.5986</td>
<td align="right">0.1153</td>
<td align="right">0.9208</td>
<td align="right">0.5156</td>
<td align="right">0.2094</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.1868</td>
<td align="right">0.6817</td>
<td align="right">0.0037</td>
<td align="right">0.0756</td>
<td align="right">0.0068</td>
<td align="right">0.3675</td>
<td align="right">0.4283</td>
<td align="right">0.2171</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.0620</td>
<td align="right">0.6319</td>
<td align="right">0.3075</td>
<td align="right">0.4575</td>
<td align="right">0.4112</td>
<td align="right">0.9876</td>
<td align="right">0.9137</td>
<td align="right">0.1086</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0009</td>
<td align="right">0.4670</td>
<td align="right">0.0023</td>
<td align="right">0.4766</td>
<td align="right">0.0024</td>
<td align="right">0.6613</td>
<td align="right">0.6894</td>
<td align="right">0.3456</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.0000</td>
<td align="right">0.2108</td>
<td align="right">0.0002</td>
<td align="right">0.4673</td>
<td align="right">0.0026</td>
<td align="right">0.3262</td>
<td align="right">0.8511</td>
<td align="right">0.4422</td>
</tr>
</tbody>
</table>
<pre class="r"><code>mod.split.tests.water &lt;- map(mod.split, multcomp::glht, 
                             linfct = multcomp::mcp(water = c(&quot;Addition - Control = 0&quot;, &quot;Reduction - Control = 0&quot;))) %&gt;% 
  map_dfr(tidy, .id=&quot;trait&quot;)

anova_table(mod.split.tests, mod.split) %&gt;% 
  left_join(mod.split.tests.water %&gt;% select(trait, contrast, adj.p.value) %&gt;% 
              pivot_wider(names_from=contrast, values_from=adj.p.value)) %&gt;% kable()</code></pre>
<table style="width:100%;">
<colgroup>
<col width="12%" />
<col width="5%" />
<col width="5%" />
<col width="5%" />
<col width="7%" />
<col width="8%" />
<col width="8%" />
<col width="12%" />
<col width="5%" />
<col width="14%" />
<col width="15%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">trait</th>
<th align="right">year</th>
<th align="right">snow</th>
<th align="right">water</th>
<th align="right">year:snow</th>
<th align="right">year:water</th>
<th align="right">snow:water</th>
<th align="right">year:snow:water</th>
<th align="right">R2m</th>
<th align="right">Addition - Control</th>
<th align="right">Reduction - Control</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.0000</td>
<td align="right">0.1519</td>
<td align="right">0.6661</td>
<td align="right">0.0120</td>
<td align="right">0.7884</td>
<td align="right">0.2773</td>
<td align="right">0.1535</td>
<td align="right">0.6027</td>
<td align="right">0.5794</td>
<td align="right">0.9137</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.0000</td>
<td align="right">0.4894</td>
<td align="right">0.5712</td>
<td align="right">0.5986</td>
<td align="right">0.1153</td>
<td align="right">0.9208</td>
<td align="right">0.5156</td>
<td align="right">0.2094</td>
<td align="right">0.5794</td>
<td align="right">0.9603</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.1868</td>
<td align="right">0.6817</td>
<td align="right">0.0037</td>
<td align="right">0.0756</td>
<td align="right">0.0068</td>
<td align="right">0.3675</td>
<td align="right">0.4283</td>
<td align="right">0.2171</td>
<td align="right">0.0034</td>
<td align="right">0.2324</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.0620</td>
<td align="right">0.6319</td>
<td align="right">0.3075</td>
<td align="right">0.4575</td>
<td align="right">0.4112</td>
<td align="right">0.9876</td>
<td align="right">0.9137</td>
<td align="right">0.1086</td>
<td align="right">0.5205</td>
<td align="right">0.5977</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0009</td>
<td align="right">0.4670</td>
<td align="right">0.0023</td>
<td align="right">0.4766</td>
<td align="right">0.0024</td>
<td align="right">0.6613</td>
<td align="right">0.6894</td>
<td align="right">0.3456</td>
<td align="right">0.1368</td>
<td align="right">0.0040</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.0000</td>
<td align="right">0.2108</td>
<td align="right">0.0002</td>
<td align="right">0.4673</td>
<td align="right">0.0026</td>
<td align="right">0.3262</td>
<td align="right">0.8511</td>
<td align="right">0.4422</td>
<td align="right">0.0051</td>
<td align="right">0.0011</td>
</tr>
</tbody>
</table>
</div>
<div id="figure-1" class="section level2">
<h2>Figure 1</h2>
<pre class="r"><code>plot_split_plot &lt;- function(emm, data, traits.plot, geom = &quot;point&quot;, plot.emm = TRUE, facets=&quot;year&quot;) {
  
  data.long &lt;- data %&gt;% select(c(all_of(traits.plot), all_of(facets), water, snow)) %&gt;% 
    pivot_longer(all_of(traits.plot), names_to=&quot;trait&quot;) %&gt;% 
    mutate(trait = fct_relevel(trait, traits.plot), snow=fct_relevel(snow, &quot;Normal&quot;)) %&gt;% 
    drop_na(value, water) %&gt;% filter(trait %in% traits.plot)
  
  traitnames.multiline &lt;- ifelse(nchar(traitnames.units) &gt; 30, str_replace(traitnames.units, fixed(&quot;(&quot;),&quot;\n(&quot;), traitnames.units)
  
  split_plot &lt;- emm %&gt;% filter(trait %in% traits.plot) %&gt;% 
    mutate(trait = fct_relevel(trait, traits.plot), snow=fct_relevel(snow, &quot;Normal&quot;)) %&gt;%  
  ggplot(aes(x=water, color=snow)) +
    labs(x=&quot;Precipitation&quot;, y=&quot;Standardized trait&quot;, color=&quot;Snowmelt&quot;) + 
    scale_y_continuous(position=&quot;right&quot;) + scale_x_discrete(guide=guide_axis(angle=90)) + 
    scale_color_manual(values=snow_pal_grey, guide=guide_legend(override.aes = list(shape=15, size=ifelse(plot.emm,5,1)))) + 
    theme_minimal() + theme(text=element_text(color=&quot;black&quot;, size=14), axis.text = element_text(color=&quot;black&quot;),
                            axis.title.y= element_blank(),
                            panel.grid.major.x = element_blank(), panel.grid.minor.x=element_blank(), panel.grid.minor.y = element_blank(),
                            panel.border = element_rect(fill=NA, colour = &quot;black&quot;), 
                            panel.spacing=unit(0, &quot;pt&quot;), plot.margin = margin(0,0,0,0, &quot;pt&quot;), legend.position = &quot;top&quot;) +
    switch(facets, 
           year = facet_grid(trait ~ year, scales=&quot;free_y&quot;, switch=&quot;y&quot;, 
                             labeller = as_labeller(c(traitnames.multiline, set_names(2018:2020)))),
           year.round = facet_grid(trait ~ year.round, scales=&quot;free_y&quot;, switch=&quot;y&quot;, 
                                   labeller = as_labeller(c(traitnames.multiline, set_names(levels(lt$year.round)))))) + 
    switch(geom,
           boxplot = geom_boxplot(data=data.long, aes(y=value), position=position_dodge(width=0.8), show.legend=!plot.emm,
                                  fatten=ifelse(plot.emm, NULL, 1), outlier.size=0.5),
           violin =   geom_violin(data=data.long, aes(y=value), position=position_dodge(width=0.8), show.legend=F),
           point =     geom_point(data=data.long, aes(y=value), position=position_dodge(width=0.8), shape=3))
  
  if(plot.emm) { return(split_plot + 
                          geom_linerange(aes(ymin=emmean-SE, ymax=emmean+SE,), position=position_dodge(width=0.8), size=1, show.legend=F) +
                          geom_point(aes(y=emmean), position=position_dodge(width=0.8), shape=&quot;-&quot;, size=16))
  } else return(split_plot)
}

#Vegetative and physiological traits - plot of EMMs and subplot means
grid.arrange(
  plot_split_plot(mod.split.emm, lt.subplotround %&gt;% filter(round==2), leaftraits), #second round only 
  plot_split_plot(mod.split.emm, pt.subplot, phystraits)+ 
    guides(color = guide_legend(override.aes = list(color=&quot;white&quot;, shape=15, size=5))) + 
    theme(legend.title = element_text(color = &quot;white&quot;), legend.text = element_text(color = &quot;white&quot;)), nrow=1)</code></pre>
<embed src="figures-pdf/Figure_1-1.pdf" width="864" type="application/pdf" />
</div>
<div id="repeated-measures" class="section level2">
<h2>Repeated measures</h2>
<div id="table-s1" class="section level3">
<h3>Table S1</h3>
<pre class="r"><code># get plants that were sampled more than once for the first three rounds
lt.long.3 &lt;- lt %&gt;% pivot_longer(all_of(leaftraits), names_to = &quot;trait&quot;) %&gt;% arrange(date) %&gt;% drop_na(value) %&gt;%
  filter(year.round %in% c(&quot;2018.1&quot;,&quot;2018.2&quot;,&quot;2019.1&quot;))
lt.long.repeated.3 &lt;- lt.long.3  %&gt;% filter(paste(trait, plantid) %in% 
                     (lt.long.3 %&gt;% group_by(plantid, trait) %&gt;% summarize(n = length(unique(year.round))) %&gt;% 
                        filter(n&gt;1) %&gt;% mutate(trait_plantid = paste(trait, plantid)) %&gt;% pull(trait_plantid))) %&gt;% 
  group_by(trait, plot, plotid, plantid, water, snow, year.round) %&gt;% summarize(value=mean(value)) 
lt.repeated.3 &lt;- lt.long.repeated.3 %&gt;% pivot_wider(names_from=&quot;trait&quot;)
lt.repeated.3.subplotround &lt;- lt.repeated.3 %&gt;% group_by(year.round, water, snow, plotid) %&gt;% 
  summarize(across(all_of(leaftraits), mean, na.rm=T))

lt.mod.split.rm.3 &lt;- map(set_names(leaftraits), 
                  ~ lmer(lt.repeated.3[[.x]] ~  year.round * water * snow + (1|snow:plot) + (1|snow:plotid) + (1|plantid), data=lt.repeated.3))
lt.mod.split.rm.3.tests &lt;- map(lt.mod.split.rm.3, anova, ddf=&quot;Ken&quot;) %&gt;% map_dfr(tidy, .id=&quot;trait&quot;)
anova_table(lt.mod.split.rm.3.tests, lt.mod.split.rm.3) %&gt;% kable()</code></pre>
<table>
<colgroup>
<col width="14%" />
<col width="9%" />
<col width="6%" />
<col width="6%" />
<col width="14%" />
<col width="13%" />
<col width="9%" />
<col width="19%" />
<col width="6%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">trait</th>
<th align="right">year.round</th>
<th align="right">water</th>
<th align="right">snow</th>
<th align="right">year.round:water</th>
<th align="right">year.round:snow</th>
<th align="right">water:snow</th>
<th align="right">year.round:water:snow</th>
<th align="right">R2m</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0</td>
<td align="right">0.8730</td>
<td align="right">0.3975</td>
<td align="right">0.7454</td>
<td align="right">0.0636</td>
<td align="right">0.7876</td>
<td align="right">0.8369</td>
<td align="right">0.5824</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0</td>
<td align="right">0.9137</td>
<td align="right">0.1228</td>
<td align="right">0.0874</td>
<td align="right">0.3010</td>
<td align="right">0.7593</td>
<td align="right">0.7196</td>
<td align="right">0.1529</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0</td>
<td align="right">0.0271</td>
<td align="right">0.6476</td>
<td align="right">0.0000</td>
<td align="right">0.1614</td>
<td align="right">0.7026</td>
<td align="right">0.5422</td>
<td align="right">0.6841</td>
</tr>
</tbody>
</table>
</div>
<div id="figure-s2" class="section level3">
<h3>Figure S2</h3>
<pre class="r"><code>lt.mod.split.rm.3.emm &lt;- map_dfr(lt.mod.split.rm.3, ~ summary(emmeans(.x, ~  year.round * water * snow)), .id=&quot;trait&quot;)
plot_split_plot(lt.mod.split.rm.3.emm, lt.repeated.3.subplotround, leaftraits, facets=&quot;year.round&quot;) </code></pre>
<embed src="figures-pdf/Figure_S2-1.pdf" width="384" type="application/pdf" />
</div>
</div>
</div>
<div id="models-with-snowmelt-date-and-total-precipitation" class="section level1">
<h1>Models with snowmelt date and total precipitation</h1>
<div id="table-2" class="section level2">
<h2>Table 2</h2>
<div id="p-values" class="section level3">
<h3>P-values</h3>
<pre class="r"><code>lt.subplot.r2 &lt;- lt.subplotround %&gt;% filter(round==&quot;2&quot;)
lt.plantyr.r2 &lt;- lt.plantyr %&gt;% filter(round==&quot;2&quot;)

options(contrasts = c(&quot;contr.sum&quot;, &quot;contr.poly&quot;))
mod.abs &lt;- c(map(set_names(leaftraits), 
                 ~ lmer(lt.plantyr.r2[[.x]] ~ sun_date * precip_est_mm + (1|plot) + (1|plotid), data=lt.plantyr.r2)),
             map(set_names(phystraits), 
                 ~ lmer(pt.plantyr[[.x]]    ~ sun_date * precip_est_mm + (1|plot) + (1|plotid) + (1|round),
                        data=pt.plantyr)))

mod.abs.coefs &lt;- map_dfr(mod.abs, tidy, .id=&quot;trait&quot;)
mod.abs.tests &lt;- map(mod.abs, anova, ddf=&quot;Ken&quot;) %&gt;% map_dfr(tidy, .id=&quot;trait&quot;)
anova_table(mod.abs.tests, mod.abs) %&gt;% kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">trait</th>
<th align="right">sun_date</th>
<th align="right">precip_est_mm</th>
<th align="right">sun_date:precip_est_mm</th>
<th align="right">R2m</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.0000</td>
<td align="right">0.4675</td>
<td align="right">0.4396</td>
<td align="right">0.5560</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.0015</td>
<td align="right">0.0066</td>
<td align="right">0.0814</td>
<td align="right">0.1893</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.9537</td>
<td align="right">0.2542</td>
<td align="right">0.3505</td>
<td align="right">0.1781</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.0052</td>
<td align="right">0.0973</td>
<td align="right">0.1531</td>
<td align="right">0.0820</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0003</td>
<td align="right">0.0247</td>
<td align="right">0.0821</td>
<td align="right">0.2300</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.0022</td>
<td align="right">0.0099</td>
<td align="right">0.0554</td>
<td align="right">0.2054</td>
</tr>
</tbody>
</table>
</div>
<div id="regression-slopes" class="section level3">
<h3>Regression slopes</h3>
<pre class="r"><code>mod.abs.coefs %&gt;% filter(effect==&quot;fixed&quot;, term!=&quot;(Intercept)&quot;) %&gt;% pivot_wider(id_cols=trait, names_from=term, values_from=c(&quot;estimate&quot;,&quot;std.error&quot;)) %&gt;% kable()</code></pre>
<table>
<colgroup>
<col width="10%" />
<col width="10%" />
<col width="13%" />
<col width="19%" />
<col width="11%" />
<col width="14%" />
<col width="19%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">trait</th>
<th align="right">estimate_sun_date</th>
<th align="right">estimate_precip_est_mm</th>
<th align="right">estimate_sun_date:precip_est_mm</th>
<th align="right">std.error_sun_date</th>
<th align="right">std.error_precip_est_mm</th>
<th align="right">std.error_sun_date:precip_est_mm</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">6.6467</td>
<td align="right">-0.7503</td>
<td align="right">0.0067</td>
<td align="right">0.9560</td>
<td align="right">1.0007</td>
<td align="right">0.0084</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">-1.3730</td>
<td align="right">-1.7834</td>
<td align="right">0.0090</td>
<td align="right">0.4267</td>
<td align="right">0.6503</td>
<td align="right">0.0051</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">-0.0001</td>
<td align="right">0.0024</td>
<td align="right">0.0000</td>
<td align="right">0.0018</td>
<td align="right">0.0020</td>
<td align="right">0.0000</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.2752</td>
<td align="right">0.1949</td>
<td align="right">-0.0013</td>
<td align="right">0.0927</td>
<td align="right">0.1165</td>
<td align="right">0.0009</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0072</td>
<td align="right">0.0040</td>
<td align="right">0.0000</td>
<td align="right">0.0017</td>
<td align="right">0.0017</td>
<td align="right">0.0000</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">-1.7948</td>
<td align="right">-1.1076</td>
<td align="right">0.0063</td>
<td align="right">0.5112</td>
<td align="right">0.4252</td>
<td align="right">0.0033</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="figure-2" class="section level2">
<h2>Figure 2</h2>
<pre class="r"><code>plot_abs &lt;- function(mod, data, traits.plot, tests=NULL, facets = &quot;trait&quot;) {
  data.long &lt;- data %&gt;% select(all_of(traits.plot), water, snow, year, sun_date, precip_est_mm) %&gt;% 
    pivot_longer(all_of(traits.plot), names_to=&quot;trait&quot;) %&gt;% 
    mutate(trait = fct_relevel(trait, traits.plot), snow=fct_relevel(snow, &quot;Normal&quot;),
                      value = (value - alltraits.mean[as.character(trait)])/alltraits.sd[as.character(trait)]) %&gt;% 
    drop_na(value, water) %&gt;% filter(trait %in% traits.plot)
  
  precip.breaks &lt;- seq(25,175, by=25)
  grid_emmeans &lt;- function(mods, use.rounds = F) {
    grid.points &lt;- list(sun_date=range(treatments$sun_date), precip_est_mm=precip.breaks)
    if(use.rounds)  map_dfr(mods, ~ summary(emmeans(.x, ~ precip_est_mm * sun_date * round, at=grid.points)), .id=&quot;trait&quot;)
    else            map_dfr(mods, ~ summary(emmeans(.x, ~ precip_est_mm * sun_date,         at=grid.points)), .id=&quot;trait&quot;)
  }
  emm.grid &lt;- mod[traits.plot] %&gt;% grid_emmeans(use.rounds= facets==&quot;trait.round&quot;) %&gt;% 
    mutate(trait = fct_relevel(trait, traits.plot),
           emmean = (emmean - alltraits.mean[as.character(trait)])/alltraits.sd[as.character(trait)])
  
  traitnames.multiline &lt;- ifelse(nchar(traitnames) &gt; 30, str_replace(traitnames, fixed(&quot;(&quot;),&quot;\n(&quot;), traitnames)
  if(!is.null(tests)) {
    tests.sig &lt;- tests %&gt;% filter(p.value &lt; 0.05) %&gt;% 
          mutate(term.abbr = str_replace_all(term, c(sun_date=&quot;Sn&quot;, precip_est_mm=&quot;Pr&quot;,`:`=&quot;\U00D7&quot;))) %&gt;% 
          group_by(trait) %&gt;% summarize(terms.sig = paste0(&quot;(&quot;,paste(term.abbr, collapse=&quot;, &quot;),&quot;)&quot;)) %&gt;% deframe
    traitnames.multiline[] &lt;- paste(traitnames.multiline, replace_na(tests.sig[alltraits], &quot;&quot;))
  }
  
  abs_plot &lt;- ggplot(emm.grid, aes(x=sun_date, y=emmean, color=precip_est_mm, group=precip_est_mm)) + 
    geom_point(data = data.long, aes(y=value, shape=year), size=2) + geom_line() + 
    scale_color_gradientn(colors=rev(water_pal), 
                          values=rev(c(1, (treatments %&gt;% group_by(water) %&gt;% summarize(across(precip_est_mm, mean)) %&gt;%
                                             pull(precip_est_mm) %&gt;% scales::rescale(from=range(precip.breaks)))[2],0)),
                          breaks=precip.breaks) + 
    labs(x=&quot;Snowmelt date (day of year)&quot;, y=&quot;Standardized trait&quot;, color=&quot;Summer\nprecipitation\n(mm)&quot;, shape=&quot;Year&quot;) + 
    scale_y_continuous(position=&quot;right&quot;)+
    theme_minimal() + theme(text=element_text(color=&quot;black&quot;, size=14), axis.text = element_text(color=&quot;black&quot;),
                            panel.border = element_rect(fill=NA, colour = &quot;black&quot;)) +
    switch(facets, 
           trait =     facet_wrap(vars(trait), scales=&quot;fixed&quot;, dir = &quot;v&quot;, ncol=2, labeller = as_labeller(traitnames.multiline)),
           trait.round = facet_grid(trait ~ round, scales=&quot;free_y&quot;, switch=&quot;y&quot;, 
                                   labeller = as_labeller(c(traitnames.multiline, 
                                                            set_names(paste(&quot;Round&quot;,1:2), 1:2)))))
    
  return(abs_plot)
}

plot_abs(mod.abs, bind_rows(lt.subplot.r2, pt.subplot), c(leaftraits[2],phystraits[c(3,1,2)])) +
  scale_y_continuous(limits=c(-1.3, 1.8), breaks=c(-2:1))#subplot means</code></pre>
<embed src="figures-pdf/Figure_2-1.pdf" width="576" type="application/pdf" />
</div>
</div>
<div id="models-with-soil-moisture" class="section level1">
<h1>Models with soil moisture</h1>
<div id="table-3" class="section level2">
<h2>Table 3</h2>
<pre class="r"><code>lt.subplot.r2 &lt;- lt.subplotround %&gt;% filter(round==&quot;2&quot;)
lt.plantyr.r2 &lt;- lt.plantyr %&gt;% filter(round==&quot;2&quot;)

pt.plantyr &lt;- pt.plantyr %&gt;% mutate(VWC = ifelse(is.na(VWC.plant), VWC.sm, VWC.plant)) #phys traits had the VWC measured next to the plant in 2019 and 2020 only - substitute VWC in subplot on closest date
pt &lt;- pt %&gt;% mutate(VWC = ifelse(is.na(VWC.plant), VWC.sm, VWC.plant)) 

options(contrasts = c(&quot;contr.sum&quot;, &quot;contr.poly&quot;))
mod.sm &lt;- c(map(set_names(leaftraits), 
                  ~ lmer(lt.plantyr.r2[[.x]] ~ year * VWC + (1|plotid), data=lt.plantyr.r2)),
            map(set_names(phystraits[1:2]), 
                  ~ lmer(pt.plantyr[[.x]]    ~ year * VWC + I(VWC^2) + (1|plotid) + (1|round), data=pt.plantyr)),
            map(set_names(phystraits[3]), 
                  ~ lmer(pt.plantyr[[.x]]    ~ year * VWC            + (1|plotid) + (1|round), data=pt.plantyr)))
#significant effect of quadratic term for sepal_width, photosynthesis, conductance, but not year * VWC^2

mod.sm.coefs &lt;- map_dfr(mod.sm, tidy, .id=&quot;trait&quot;)
mod.sm.tests &lt;- map(mod.sm, anova, ddf=&quot;Ken&quot;) %&gt;% map_dfr(tidy, .id=&quot;trait&quot;)
anova_table(mod.sm.tests, mod.sm) %&gt;% kable()</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">trait</th>
<th align="right">year</th>
<th align="right">VWC</th>
<th align="right">year:VWC</th>
<th align="right">I(VWC^2)</th>
<th align="right">R2m</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.0116</td>
<td align="right">0.1658</td>
<td align="right">0.3953</td>
<td align="right">NA</td>
<td align="right">0.5847</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.0001</td>
<td align="right">0.9058</td>
<td align="right">0.0330</td>
<td align="right">NA</td>
<td align="right">0.1950</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.1778</td>
<td align="right">0.0001</td>
<td align="right">0.0829</td>
<td align="right">NA</td>
<td align="right">0.1835</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.4488</td>
<td align="right">0.0002</td>
<td align="right">0.6687</td>
<td align="right">0.0055</td>
<td align="right">0.1497</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0009</td>
<td align="right">0.0001</td>
<td align="right">0.0219</td>
<td align="right">0.0389</td>
<td align="right">0.3858</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.0000</td>
<td align="right">0.0000</td>
<td align="right">0.0030</td>
<td align="right">NA</td>
<td align="right">0.4346</td>
</tr>
</tbody>
</table>
</div>
<div id="figure-3" class="section level2">
<h2>Figure 3</h2>
<pre class="r"><code>plot_sm &lt;- function(mod, data, traits.plot, tests=NULL) {
  data.long &lt;- data %&gt;% select(all_of(traits.plot), water, snow, year, sun_date, precip_est_mm, VWC) %&gt;% 
    pivot_longer(all_of(traits.plot), names_to=&quot;trait&quot;) %&gt;% 
    mutate(trait = fct_relevel(trait, traits.plot), snow=fct_relevel(snow, &quot;Normal&quot;),
                      value = (value - alltraits.mean[as.character(trait)])/alltraits.sd[as.character(trait)]) %&gt;% 
    drop_na(value, water) %&gt;% filter(trait %in% traits.plot)
  
  VWC.range &lt;- range(data$VWC, na.rm=T)
  emm.grid &lt;- mod[traits.plot] %&gt;% 
    map_dfr(~ emmeans(.x, ~ year*VWC, at=list(VWC=seq(from=floor(VWC.range[1]*10)/10, to=ceiling(VWC.range[2]*10)/10, by=0.1))) %&gt;% as_tibble(), .id=&quot;trait&quot;) %&gt;% 
    mutate(trait = fct_relevel(trait, traits.plot),
           emmean = (emmean - alltraits.mean[as.character(trait)])/alltraits.sd[as.character(trait)]) %&gt;% 
    left_join(data %&gt;% drop_na(VWC) %&gt;% group_by(year) %&gt;% summarize(VWC.min = min(VWC), VWC.max=max(VWC))) %&gt;%
    group_by(year) %&gt;% filter(VWC &gt;= VWC.min-0.1, VWC &lt;= VWC.max+0.1)
  
  traitnames.multiline &lt;- ifelse(nchar(traitnames) &gt; 30, str_replace(traitnames, fixed(&quot;(&quot;),&quot;\n(&quot;), traitnames)
  if(!is.null(tests)) {
    tests.sig &lt;- tests %&gt;% filter(p.value &lt; 0.05) %&gt;% 
          mutate(term.abbr = str_replace_all(term, c(year=&quot;Yr&quot;, VWC=&quot;SM&quot;,`:`=&quot;\U00D7&quot;))) %&gt;% 
          group_by(trait) %&gt;% summarize(terms.sig = paste0(&quot;(&quot;,paste(term.abbr, collapse=&quot;, &quot;),&quot;)&quot;)) %&gt;% deframe
    print(tests.sig[traits.plot])
    traitnames.multiline[] &lt;- paste(traitnames.multiline, replace_na(tests.sig[alltraits], &quot;&quot;))
  }
  
  sm_plot &lt;- ggplot(emm.grid, aes(x=VWC, y=emmean, color=year, group=year)) + 
    facet_wrap(vars(trait), scales=&quot;fixed&quot;, dir=&quot;v&quot;, ncol=ifelse(length(traits.plot)&gt;3,2,4), labeller = as_labeller(traitnames.multiline))+
    geom_point(data = data.long, aes(y=value, color=year), size=1) +  
    geom_line(size=2) + 
    scale_color_manual(values=year_pal) + ylab(&quot;Standardized trait&quot;) + labs(color=&quot;Year&quot;) + 
    theme_minimal() + theme(text=element_text(color=&quot;black&quot;, size=14), axis.text = element_text(color=&quot;black&quot;),
                            panel.border = element_rect(fill=NA, colour = &quot;black&quot;))
  return(sm_plot)
}

grid.arrange(
  plot_sm(mod.sm, lt.plantyr.r2, leaftraits) + 
    xlab(&quot;Summer mean of soil moisture in subplot (%VWC)&quot;),
  plot_sm(mod.sm, pt.plantyr, phystraits) + 
    xlab(&quot;Soil moisture next to plant or in subplot on closest date (%VWC)&quot;) +
    guides(color = guide_legend(override.aes = list(color=&quot;white&quot;, shape=15, size=5))) + 
    theme(legend.title = element_text(color = &quot;white&quot;), legend.text = element_text(color = &quot;white&quot;)), ncol=1)</code></pre>
<embed src="figures-pdf/Figure_3-1.pdf" width="768" type="application/pdf" />
</div>
</div>
<div id="fitness-vs.-treatments" class="section level1">
<h1>Fitness vs. treatments</h1>
<div id="table-s2" class="section level2">
<h2>Table S2</h2>
<pre class="r"><code>#Model effect of treatments on survival and flowering of vegetative plants - both years combined
cen.status.fitness &lt;- cen.status.long %&gt;% filter(status==&quot;vegetative&quot;, census %in% c(&quot;2018&quot;,&quot;2019&quot;,&quot;2020&quot;)) %&gt;%
  full_join(cen.RGR.long %&gt;% drop_na(RGR) %&gt;% filter(census!=&quot;18r2&quot;) %&gt;% select(-census)) %&gt;% left_join(treatments) %&gt;% left_join(sm.subplotyear)

options(contrasts = c(&quot;contr.sum&quot;, &quot;contr.poly&quot;))
fitness.mod &lt;- map(set_names(fitnesstraits), 
                    ~ glmmTMB(cen.status.fitness[[.x]] ~ year * snow * water + (1|snow:plot) + (1|snow:plotid), data=cen.status.fitness, 
                              family=ifelse(.x ==&quot;RGR&quot;, &quot;gaussian&quot;, &quot;binomial&quot;))) 

fitness.mod.coefs &lt;- map_dfr(fitness.mod, tidy, .id=&quot;trait&quot;)
fitness.mod.tests &lt;- map(fitness.mod, car::Anova, type=3) %&gt;% map_dfr(tidy, .id=&quot;trait&quot;)
fitness.mod.emm &lt;- map_dfr(fitness.mod, ~ summary(emmeans(ref_grid(.x), ~ year * snow * water)), .id = &quot;trait&quot;) %&gt;% 
  mutate(uSE = ifelse(trait==&quot;RGR&quot;, emmean+SE, plogis(emmean+SE)), 
         lSE = ifelse(trait==&quot;RGR&quot;, emmean-SE, plogis(emmean-SE)), 
         emmean = ifelse(trait==&quot;RGR&quot;, emmean, plogis(emmean)),
         trait = fct_relevel(trait, fitnesstraits)) 
Anova_table(fitness.mod.tests) %&gt;% kable()</code></pre>
<table>
<colgroup>
<col width="10%" />
<col width="13%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="11%" />
<col width="12%" />
<col width="12%" />
<col width="17%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Trait</th>
<th align="right">(Intercept)</th>
<th align="right">year</th>
<th align="right">snow</th>
<th align="right">water</th>
<th align="right">year:snow</th>
<th align="right">year:water</th>
<th align="right">snow:water</th>
<th align="right">year:snow:water</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">survived</td>
<td align="right">0</td>
<td align="right">0.0654</td>
<td align="right">0.7972</td>
<td align="right">0.4211</td>
<td align="right">0.5528</td>
<td align="right">0.3943</td>
<td align="right">0.5450</td>
<td align="right">0.0168</td>
</tr>
<tr class="even">
<td align="left">RGR</td>
<td align="right">0</td>
<td align="right">0.0000</td>
<td align="right">0.0897</td>
<td align="right">0.0785</td>
<td align="right">0.0485</td>
<td align="right">0.0000</td>
<td align="right">0.5893</td>
<td align="right">0.0082</td>
</tr>
<tr class="odd">
<td align="left">flowered</td>
<td align="right">0</td>
<td align="right">0.0000</td>
<td align="right">0.8817</td>
<td align="right">0.0885</td>
<td align="right">0.3232</td>
<td align="right">0.4297</td>
<td align="right">0.6055</td>
<td align="right">0.0903</td>
</tr>
</tbody>
</table>
</div>
<div id="figure-s3" class="section level2">
<h2>Figure S3</h2>
<pre class="r"><code>ggplot(fitness.mod.emm %&gt;% mutate(snow=fct_relevel(snow, &quot;Normal&quot;, &quot;Early&quot;)), aes(x=water, color=snow, y=emmean)) + 
  facet_grid(trait ~ year, scales=&quot;free_y&quot;, labeller = as_labeller(c(fitnessnames, set_names(2018:2020))), switch=&quot;y&quot;, as.table=F)+
  geom_hline(data=data.frame(trait = fitnesstraits, plot=c(NA,NA,&quot;yes&quot;)), aes(linetype=plot, yintercept=0), color=&quot;grey&quot;)+
  guides(linetype=&quot;none&quot;)+
  geom_linerange(aes(ymin=lSE, ymax=uSE), position=position_dodge(width=0.8), size=1, show.legend=F) +
  geom_point(position=position_dodge(width=0.8), shape=&quot;-&quot;, size=16) + 
  labs(x=&quot;Precipitation&quot;, color=&quot;Snowmelt&quot;) + 
  scale_y_continuous(position=&quot;right&quot;, expand=expansion(mult=c(0,0.05)))  + scale_x_discrete(guide=guide_axis(angle=90))+ 
  scale_color_manual(values=snow_pal_grey, guide=guide_legend(override.aes = list(shape=15, size=5))) + 
  theme_minimal() + theme(text=element_text(color=&quot;black&quot;, size=14), axis.text = element_text(color=&quot;black&quot;),
                          axis.title.y= element_blank(),
                          panel.border = element_rect(fill=NA, colour = &quot;black&quot;),
                          panel.spacing.x=unit(0, &quot;lines&quot;), panel.spacing.y=unit(1, &quot;lines&quot;),
                          plot.margin = margin(0,0,0,0, &quot;pt&quot;), legend.position = &quot;top&quot;) </code></pre>
<embed src="figures-pdf/Figure_S3-1.pdf" width="432" type="application/pdf" />
</div>
</div>
<div id="selection" class="section level1">
<h1>Selection</h1>
<pre class="r"><code>lt.plantyr.r2 &lt;- lt.plantyr %&gt;% filter(round==&quot;2&quot;)

step_selection_mod &lt;- function(trait, response, treatment, set, drop=TRUE) { 
  family &lt;- ifelse(response==&quot;RGR&quot;, &quot;gaussian&quot;, &quot;binomial&quot;) 
  re &lt;- ifelse(treatment ==&quot;snow&quot;, &quot;snow:plot&quot;, &quot;plot&quot;)
  t.plantyr &lt;- list(lt = lt.plantyr.r2, pt = pt.plantyr)[[set]] %&gt;% rename(&quot;trait&quot;=trait)
  options(contrasts = c(&quot;contr.sum&quot;, &quot;contr.poly&quot;))
  mod &lt;- glmmTMB(formula(paste(response, &quot;~ trait * year * &quot;, treatment,&quot; + (1|&quot;,re,&quot;)&quot;)), 
                 data=t.plantyr, family=family)
  if(drop) {
    droporder &lt;- c(paste0(&quot;trait:year:&quot;, treatment)) 
    for(term_test in droporder) {
      pval &lt;- car::Anova(mod) %&gt;% tidy %&gt;% filter(term==term_test) %&gt;% pull(p.value)
      if(pval &lt; 0.05) return(mod)
      else mod &lt;- update(mod, formula(paste0(&quot;. ~ . -&quot;, term_test)))
    }
  }
  return(mod)
}

selection.combos &lt;- expand_grid(response = fitnesstraits, treatment=c(&quot;water&quot;,&quot;snow&quot;), set = c(&quot;lt&quot;, &quot;pt&quot;)) 
mod.selection &lt;- selection.combos  %&gt;% 
  full_join(tibble(trait=c(leaftraits, phystraits), 
                   set = c(rep(&quot;lt&quot;, length(leaftraits)), rep(&quot;pt&quot;, length(phystraits))))) %&gt;% 
  mutate(full_model = pmap(., step_selection_mod, drop=F), 
         model =      pmap(., step_selection_mod, drop=T),
         coefs = map(model, tidy),
         tests = map(model, ~ tidy(car::Anova(., type=3))))

emt.selection &lt;- mod.selection %&gt;% 
  mutate(yrtrend = map2(full_model, treatment, 
                        ~tidy(emtrends(.x, specs=c(&quot;year&quot;,as.character(.y)), var=&quot;trait&quot;)))) %&gt;%
  select(response, treatment, trait, yrtrend) %&gt;% unnest(yrtrend) %&gt;% 
  mutate(sd.trait=alltraits.sd[trait], 
         trait.trend.sd = trait.trend*sd.trait, std.error.sd=std.error*sd.trait) #multiply by SDto get change in fitness per SD</code></pre>
<div id="table-s3" class="section level2">
<h2>Table S3</h2>
<pre class="r"><code>mod.selection %&gt;% group_by(treatment, response) %&gt;%
  group_walk(function(.x,.y) {cat(paste(&quot;Effect of trait on whether a plant&quot;,
                                        ifelse(.y$response==&quot;RGR&quot;, &quot;grew faster&quot;, as.character(.y$response)),
                                        &quot;under different&quot;,.y$treatment,&quot;conditions&quot;)); 
    Anova_table(.x %&gt;% unnest(tests)) %&gt;% kable() %&gt;% print})</code></pre>
<p>Effect of trait on whether a plant flowered under different snow conditions</p>
<table style="width:100%;">
<colgroup>
<col width="17%" />
<col width="12%" />
<col width="7%" />
<col width="7%" />
<col width="7%" />
<col width="11%" />
<col width="11%" />
<col width="10%" />
<col width="16%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Trait</th>
<th align="right">(Intercept)</th>
<th align="right">trait</th>
<th align="right">year</th>
<th align="right">snow</th>
<th align="right">trait:year</th>
<th align="right">trait:snow</th>
<th align="right">year:snow</th>
<th align="right">trait:year:snow</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.3317</td>
<td align="right">0.1159</td>
<td align="right">0.4337</td>
<td align="right">0.7854</td>
<td align="right">0.4741</td>
<td align="right">0.9760</td>
<td align="right">0.0315</td>
<td align="right">0.0292</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.0001</td>
<td align="right">0.5036</td>
<td align="right">0.1254</td>
<td align="right">0.2700</td>
<td align="right">0.9762</td>
<td align="right">0.5908</td>
<td align="right">0.8727</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.9481</td>
<td align="right">0.6631</td>
<td align="right">0.1364</td>
<td align="right">0.4622</td>
<td align="right">0.1781</td>
<td align="right">0.5110</td>
<td align="right">0.3869</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.0049</td>
<td align="right">0.8196</td>
<td align="right">0.0241</td>
<td align="right">0.6761</td>
<td align="right">0.7605</td>
<td align="right">0.8938</td>
<td align="right">0.9809</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0000</td>
<td align="right">0.1004</td>
<td align="right">0.0802</td>
<td align="right">0.6564</td>
<td align="right">0.5563</td>
<td align="right">0.2719</td>
<td align="right">0.7909</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.2426</td>
<td align="right">0.2001</td>
<td align="right">0.0113</td>
<td align="right">0.0846</td>
<td align="right">0.1994</td>
<td align="right">0.0825</td>
<td align="right">0.3988</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<p>Effect of trait on whether a plant grew faster under different snow conditions</p>
<table>
<thead>
<tr class="header">
<th align="left">Trait</th>
<th align="right">(Intercept)</th>
<th align="right">trait</th>
<th align="right">year</th>
<th align="right">snow</th>
<th align="right">trait:year</th>
<th align="right">trait:snow</th>
<th align="right">year:snow</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.7052</td>
<td align="right">0.3816</td>
<td align="right">0.8329</td>
<td align="right">0.2508</td>
<td align="right">0.5087</td>
<td align="right">0.3092</td>
<td align="right">0.5174</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.2207</td>
<td align="right">0.5082</td>
<td align="right">0.0726</td>
<td align="right">0.5553</td>
<td align="right">0.5807</td>
<td align="right">0.4760</td>
<td align="right">0.6075</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.0360</td>
<td align="right">0.0185</td>
<td align="right">0.3471</td>
<td align="right">0.7810</td>
<td align="right">0.2428</td>
<td align="right">0.8452</td>
<td align="right">0.6853</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.9038</td>
<td align="right">0.3558</td>
<td align="right">0.5644</td>
<td align="right">0.3127</td>
<td align="right">0.1033</td>
<td align="right">0.9416</td>
<td align="right">0.2709</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.4514</td>
<td align="right">0.8889</td>
<td align="right">0.8290</td>
<td align="right">0.3335</td>
<td align="right">0.0692</td>
<td align="right">0.5832</td>
<td align="right">0.2541</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.1721</td>
<td align="right">0.5663</td>
<td align="right">0.0367</td>
<td align="right">0.6402</td>
<td align="right">0.6375</td>
<td align="right">0.7271</td>
<td align="right">0.2155</td>
</tr>
</tbody>
</table>
<p>Effect of trait on whether a plant survived under different snow conditions</p>
<table>
<thead>
<tr class="header">
<th align="left">Trait</th>
<th align="right">(Intercept)</th>
<th align="right">trait</th>
<th align="right">year</th>
<th align="right">snow</th>
<th align="right">trait:year</th>
<th align="right">trait:snow</th>
<th align="right">year:snow</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.0815</td>
<td align="right">0.4025</td>
<td align="right">0.8758</td>
<td align="right">0.2835</td>
<td align="right">0.9105</td>
<td align="right">0.3375</td>
<td align="right">0.5697</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.0068</td>
<td align="right">0.2875</td>
<td align="right">0.6033</td>
<td align="right">0.5454</td>
<td align="right">0.9035</td>
<td align="right">0.3011</td>
<td align="right">0.6245</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.4344</td>
<td align="right">0.7356</td>
<td align="right">0.7422</td>
<td align="right">0.3973</td>
<td align="right">0.8272</td>
<td align="right">0.4326</td>
<td align="right">0.9464</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.0000</td>
<td align="right">0.2788</td>
<td align="right">0.3959</td>
<td align="right">0.3410</td>
<td align="right">0.4093</td>
<td align="right">0.4677</td>
<td align="right">0.5303</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0000</td>
<td align="right">0.5287</td>
<td align="right">0.9881</td>
<td align="right">0.9740</td>
<td align="right">0.9567</td>
<td align="right">0.4986</td>
<td align="right">0.9033</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.0001</td>
<td align="right">0.2857</td>
<td align="right">0.2494</td>
<td align="right">0.0283</td>
<td align="right">0.2041</td>
<td align="right">0.0354</td>
<td align="right">0.6202</td>
</tr>
</tbody>
</table>
<p>Effect of trait on whether a plant flowered under different water conditions</p>
<table>
<thead>
<tr class="header">
<th align="left">Trait</th>
<th align="right">(Intercept)</th>
<th align="right">trait</th>
<th align="right">year</th>
<th align="right">water</th>
<th align="right">trait:year</th>
<th align="right">trait:water</th>
<th align="right">year:water</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.5329</td>
<td align="right">0.1689</td>
<td align="right">0.9884</td>
<td align="right">0.2451</td>
<td align="right">0.9449</td>
<td align="right">0.3231</td>
<td align="right">0.0555</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.0007</td>
<td align="right">0.5407</td>
<td align="right">0.1706</td>
<td align="right">0.7915</td>
<td align="right">0.9078</td>
<td align="right">0.9320</td>
<td align="right">0.3337</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.8205</td>
<td align="right">0.5025</td>
<td align="right">0.1750</td>
<td align="right">0.6309</td>
<td align="right">0.2268</td>
<td align="right">0.7004</td>
<td align="right">0.3672</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.0495</td>
<td align="right">0.6821</td>
<td align="right">0.0300</td>
<td align="right">0.1912</td>
<td align="right">0.8794</td>
<td align="right">0.3623</td>
<td align="right">0.8151</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0004</td>
<td align="right">0.5845</td>
<td align="right">0.0654</td>
<td align="right">0.2286</td>
<td align="right">0.4345</td>
<td align="right">0.1494</td>
<td align="right">0.7986</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.3530</td>
<td align="right">0.2789</td>
<td align="right">0.0076</td>
<td align="right">0.5942</td>
<td align="right">0.1261</td>
<td align="right">0.8670</td>
<td align="right">0.8587</td>
</tr>
</tbody>
</table>
<p>Effect of trait on whether a plant grew faster under different water conditions</p>
<table>
<thead>
<tr class="header">
<th align="left">Trait</th>
<th align="right">(Intercept)</th>
<th align="right">trait</th>
<th align="right">year</th>
<th align="right">water</th>
<th align="right">trait:year</th>
<th align="right">trait:water</th>
<th align="right">year:water</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.6134</td>
<td align="right">0.9749</td>
<td align="right">0.7442</td>
<td align="right">0.7135</td>
<td align="right">0.9586</td>
<td align="right">0.7040</td>
<td align="right">0.4100</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.3216</td>
<td align="right">0.4079</td>
<td align="right">0.1476</td>
<td align="right">0.5695</td>
<td align="right">0.2681</td>
<td align="right">0.9229</td>
<td align="right">0.0053</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.8444</td>
<td align="right">0.6500</td>
<td align="right">0.4799</td>
<td align="right">0.8091</td>
<td align="right">0.6138</td>
<td align="right">0.9147</td>
<td align="right">0.1149</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.6730</td>
<td align="right">0.5055</td>
<td align="right">0.1163</td>
<td align="right">0.0069</td>
<td align="right">0.6106</td>
<td align="right">0.3151</td>
<td align="right">0.0400</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0320</td>
<td align="right">0.3380</td>
<td align="right">0.3055</td>
<td align="right">0.0144</td>
<td align="right">0.6306</td>
<td align="right">0.4573</td>
<td align="right">0.0343</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.7578</td>
<td align="right">0.2953</td>
<td align="right">0.5070</td>
<td align="right">0.0731</td>
<td align="right">0.9072</td>
<td align="right">0.2128</td>
<td align="right">0.0087</td>
</tr>
</tbody>
</table>
<p>Effect of trait on whether a plant survived under different water conditions</p>
<table>
<thead>
<tr class="header">
<th align="left">Trait</th>
<th align="right">(Intercept)</th>
<th align="right">trait</th>
<th align="right">year</th>
<th align="right">water</th>
<th align="right">trait:year</th>
<th align="right">trait:water</th>
<th align="right">year:water</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">sla</td>
<td align="right">0.0344</td>
<td align="right">0.2066</td>
<td align="right">0.9756</td>
<td align="right">0.6896</td>
<td align="right">0.8533</td>
<td align="right">0.7193</td>
<td align="right">0.5622</td>
</tr>
<tr class="even">
<td align="left">trichome_density</td>
<td align="right">0.0085</td>
<td align="right">0.3653</td>
<td align="right">0.8689</td>
<td align="right">0.6346</td>
<td align="right">0.9392</td>
<td align="right">0.8250</td>
<td align="right">0.2619</td>
</tr>
<tr class="odd">
<td align="left">water_content</td>
<td align="right">0.2525</td>
<td align="right">0.4137</td>
<td align="right">0.8880</td>
<td align="right">0.9807</td>
<td align="right">0.9246</td>
<td align="right">0.9974</td>
<td align="right">0.2139</td>
</tr>
<tr class="even">
<td align="left">photosynthesis</td>
<td align="right">0.0000</td>
<td align="right">0.1342</td>
<td align="right">0.4205</td>
<td align="right">0.5193</td>
<td align="right">0.4314</td>
<td align="right">0.3896</td>
<td align="right">0.9250</td>
</tr>
<tr class="odd">
<td align="left">conductance</td>
<td align="right">0.0000</td>
<td align="right">0.6037</td>
<td align="right">0.9599</td>
<td align="right">0.0738</td>
<td align="right">0.9287</td>
<td align="right">0.0133</td>
<td align="right">0.4460</td>
</tr>
<tr class="even">
<td align="left">WUE</td>
<td align="right">0.0019</td>
<td align="right">0.3059</td>
<td align="right">0.1869</td>
<td align="right">0.6154</td>
<td align="right">0.1268</td>
<td align="right">0.5005</td>
<td align="right">0.8476</td>
</tr>
</tbody>
</table>
<pre class="r"><code>plot_selection_facets &lt;- function(response, treatment) {
  emt.selection.filtered &lt;- emt.selection %&gt;% 
    select(!!!treatment, response, year, trait, p.value) %&gt;% 
    drop_na(!!!treatment) %&gt;% filter(response==!!response) %&gt;% 
    mutate(sig = ifelse(p.value &lt; 0.05,&quot;signif&quot;,&quot;ns&quot;))
  
  p &lt;- bind_rows(lt.plantyr.r2, pt.plantyr) %&gt;% 
    pivot_longer(all_of(c(leaftraits, phystraits)), names_to=&quot;trait&quot;) %&gt;% 
    left_join(emt.selection.filtered) %&gt;% 
    mutate(trait = fct_relevel(trait, c(leaftraits, phystraits))) %&gt;% 
    ggplot(aes_string(y=response, x=&quot;value&quot;, color=treatment, linetype=&quot;year&quot;)) + 
    facet_wrap(vars(trait), scales=&quot;free_x&quot;, labeller = as_labeller(traitnames.units))+
    scale_color_manual(values=list(water=water_pal, snow=snow_pal)[[treatment]]) + 
    scale_linetype_manual(values=c(&quot;22&quot;,&quot;solid&quot;,&quot;42&quot;)) +
    labs(linetype=&quot;Year&quot;, shape=&quot;Year&quot;, x=&quot;&quot;, y=fitnessnames[response],
         color=c(water=&quot;Precipitation&quot;,snow=&quot;Snowmelt&quot;)[treatment]) + 
    theme_minimal() + 
    theme(text = element_text(color=&quot;black&quot;), axis.text = element_text(color=&quot;black&quot;),
          panel.border = element_rect(fill=NA, colour = &quot;black&quot;), 
          panel.spacing=unit(0, &quot;pt&quot;), plot.margin = margin(0,0,0,0, &quot;pt&quot;), 
          legend.position = &quot;top&quot;, legend.key.width = unit(2, &quot;lines&quot;))
  
  if(response ==&quot;RGR&quot;) {
    p &lt;- p + geom_hline(yintercept=0, color=&quot;grey&quot;) +
      geom_point(aes(shape=year)) + 
      geom_line(stat=&quot;smooth&quot;, size=1, se=F, method=&quot;lm&quot;)
  }  else {
    p &lt;- p + geom_point(shape=&quot;|&quot;) + 
      geom_line(stat=&quot;smooth&quot;, size=1, se=F, 
                  method=&quot;glm&quot;, method.args = list(family=&quot;binomial&quot;)) +
      scale_y_continuous(labels=scales::label_percent(accuracy=1))
  }
  #get rightmost edge of geom_smooths to add signif labels
  smooth.ends &lt;- layer_data(p, ifelse(response==&quot;RGR&quot;, 3, 2)) %&gt;% #hline adds a layer
    group_by(group, PANEL) %&gt;% filter(x==max(x)) %&gt;% ungroup() %&gt;% select(-PANEL) %&gt;% 
    bind_cols(emt.selection.filtered) %&gt;% 
    filter(sig==&quot;signif&quot;) %&gt;% 
    mutate(trait = factor(trait, levels=c(leaftraits, phystraits))) 
  p + geom_point(data=smooth.ends, aes(x=x,y=y), color=&quot;black&quot;, shape=8, size=2, inherit.aes = F)
}

selection_plots &lt;- expand_grid(treatment=c(&quot;water&quot;,&quot;snow&quot;), response = fitnesstraits) %&gt;% 
  mutate(plot = pmap(., plot_selection_facets))</code></pre>
</div>
<div id="figure-4" class="section level2">
<h2>Figure 4</h2>
<pre class="r"><code>selection_plots$plot[[1]] + selection_plots$plot[[3]] + 
  plot_layout(guides = &quot;collect&quot;, ncol=1) &amp; theme(legend.position=&quot;top&quot;)</code></pre>
<embed src="figures-pdf/Figure_4-1.pdf" width="864" type="application/pdf" />
</div>
<div id="figure-5" class="section level2">
<h2>Figure 5</h2>
<pre class="r"><code>selection_plots$plot[[2]]</code></pre>
<embed src="figures-pdf/Figure_5-1.pdf" width="864" type="application/pdf" />
</div>
<div id="figure-s4" class="section level2">
<h2>Figure S4</h2>
<pre class="r"><code>(selection_plots$plot[[4]] + guides(linetype=&quot;none&quot;, color=&quot;none&quot;)) +
selection_plots$plot[[5]] +
(selection_plots$plot[[6]] + guides(linetype=&quot;none&quot;, color=&quot;none&quot;)) +
  plot_layout(guides = &quot;collect&quot;, ncol=1) &amp; theme(legend.position=&quot;top&quot;)</code></pre>
<embed src="figures-pdf/Figure_S4-1.pdf" width="864" type="application/pdf" />
</div>
</div>
<div id="timing" class="section level1">
<h1>Timing</h1>
<div id="figure-s1" class="section level2">
<h2>Figure S1</h2>
<pre class="r"><code>  timings_labels &lt;- c(snowcloth=&quot;Snow cloths applied to early plots&quot;, 
                     meltdates=&quot;Mean early and normal snowmelt timing&quot;, 
                     waterdates=&quot;Summer precipitation treatments applied&quot;,
                     sm=&quot;Soil moisture recorded&quot;,         ph=&quot;Inflorescence height recorded&quot;, 
                     mt=&quot;Floral morphology recorded&quot;,     nt=&quot;Nectar traits recorded&quot;, 
                     pt= &quot;Physiology traits recorded&quot;,    lt=&quot;Vegetative traits recorded&quot;, 
                     sds=&quot;Flower collection period&quot;,      cen=&quot;Rosette size and survival recorded&quot;)

plot_timings &lt;- function(data) {
  data %&gt;% mutate(variable=fct_reorder(variable, begin, na.rm=T, .desc=T),
                  drawline = ifelse(variable %in% c(&quot;lt&quot;,&quot;meltdates&quot;), NA, TRUE)) %&gt;% 
ggplot(aes(y=variable, color=year))+ 
  geom_linerange(aes(xmin=begin, xmax=end, linetype=drawline), 
                 position = position_dodge2(width=0.7, reverse = T), size=1.2, show.legend=FALSE) + 
  geom_text(data=data %&gt;% drop_na(plots) %&gt;% filter(year==&quot;2019&quot;),
            aes(x = end+7, label=paste(ifelse(nchar(plots)&gt;1, &quot;Plots&quot;,&quot;Plot&quot;), str_replace(plots,&quot;,&quot;,&quot; &amp; &quot;))), 
            position = position_dodge2(width=0.8, reverse = T), size=4, hjust=0, show.legend=FALSE)+
  geom_point(aes(x=begin), position = position_dodge2(width=0.7, reverse = T), shape=15, size=2)+
  geom_point(aes(x=end), position = position_dodge2(width=0.7, reverse = T), shape=15, size=2) +
  scale_color_manual(&quot;Year&quot;, values=c(year_pal, `2021`=brewer.pal(8, name=&quot;Set2&quot;)[[4]]), guide=guide_legend(override.aes = list(size=5))) + 
  scale_y_discrete(&quot;&quot;, labels=timings_labels)+
  scale_x_continuous(&quot;Day of year&quot;, breaks=seq(80,240, by=20)) +
  theme_minimal() + theme(legend.position = &quot;top&quot;, text=element_text(size=14, color=&quot;black&quot;), axis.text = element_text(color=&quot;black&quot;),
                            panel.border = element_rect(fill=NA, colour = &quot;black&quot;))
}

plot_timings(filter(timings, !variable %in% c(&quot;sds&quot;,&quot;mt&quot;,&quot;nt&quot;,&quot;ph&quot;)))</code></pre>
<embed src="figures-pdf/Figure_S1-1.pdf" width="672" type="application/pdf" />
</div>
</div>
<div id="experiment-map" class="section level1">
<h1>Experiment map</h1>
<div id="methods-s1" class="section level2">
<h2>Methods S1</h2>
<pre class="r"><code>subplot_offset &lt;- 1/6
size_meter &lt;- 6
ggplot(treatments_map) + coord_fixed(clip=&quot;off&quot;)+
  geom_point(aes(x=plot_x, y=plot_y, fill=snow), size=7*size_meter, shape=22, stroke=1)+
  scale_fill_manual(&quot;Snowmelt&quot;, values=snow_pal, guide=guide_legend(override.aes = list(size = 2*size_meter)))+
  new_scale_fill()+
  geom_point(aes(x=plot_x+subplot_x*subplot_offset, y=plot_y+subplot_y*subplot_offset, fill=water4), size=2*size_meter, shape=22, stroke=1) + 
    geom_text(aes(x=plot_x+subplot_x*subplot_offset, y=plot_y+subplot_y*subplot_offset, label=subplot)) + 
  scale_fill_manual(&quot;Precipitation&quot;, values=water4_pal) +
  geom_text(aes(x=plot_x, y=plot_y, label=plot))+ theme_minimal() + 
  theme(legend.position=&quot;right&quot;, axis.title=element_blank(), axis.text = element_blank(), 
        axis.ticks = element_blank(), panel.background = element_blank(), panel.grid = element_blank())</code></pre>
<embed src="figures-pdf/Methods_S1-1.pdf" width="624" type="application/pdf" />
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
